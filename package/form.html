<!DOCTYPE html>
<html>
<head>
<script type="text/javascript">var _speedMark = new Date();</script>
<title>SmartHost</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="content-type" content="text/html; charset=GB2312" />
<meta name="author" content="mooringniu" />
<meta name="url" content="http://code.google.com/p/smarthost" />
<meta name="description" content="SmartHost A Remote IP/Host Remap Plugin for Fiddler" />
<style type="text/css" media="screen">
body{margin:0;padding:0;font-size:1.2em;line-height:1em;font-weight:600;max-width:device-width;min-width:320px;}
form{text-align: left;margin:0; padding:0; }
form input,form select,form button{ width:100%; line-height:1.2em;font-size:1.2em;}
form .input{ width: 90% !important; }
</style>
</head>
<body>
<form method="POST" action="/" onsubmit="return saveData()">
<fieldset>
    <legend>SmartHost</legend>
    localhost<select name="localhost">
        <option value="" selected comment="IDC HOST">现网Host</option>
        <option value="127.0.0.1">127.0.0.1</option>
    </select>
    <span holder></span>
    Custom:
    <div class="info">
        <input class="input" type="text" key="key" placeholder="Domain" value="">
        <input class="input" type="text" key="val" maxlength="15" placeholder="IP/Empty For IDC" placeholder="IP/留空表示现网" />
        <hr border="0" color="#eeeeee"/>
    </div>
    <input type="button" onclick="addHost(this);return false;" id="addBtnOne" value="Add More" />
    <br/> <br/>
    <input type="hidden" name="oid" id="oidInput" value="" />
    <input type="submit" value="Submit">
</fieldset>
</form>
<p style="font-weight:normal">
    After submit, your remote Proxy will be not use if it was configed before.
</p>
<script type="text/javascript">
var sLocal = 'localStorage' in window,
    remoteConfig = {};
function addHost(obj){
    var div = customDiv.cloneNode(true);
    obj.parentNode.insertBefore(div,obj);
}
function saveData(){
    ipts = document.getElementsByTagName("select");
    divs = document.getElementsByTagName('div');
    var localData = {};
    for(var i=0,il=ipts.length; i<il; i++){
        if(/[\w\d]+\.[\w\d]+/.test(ipts[i].name)){
            localData[ipts[i].name]=ipts[i].value;
        }
    }
    for(var j=0,jl=divs.length;j<jl;j++){
        var child = divs[j].childNodes, item = '',
            kv = {}, k = '', key = '', val = '';
        for(var i=0,il=child.length;i<il;i++){
            kv = child[i];
            if(kv.tagName=='INPUT'){
               k = kv.getAttribute('key');
               if(k=='key' && /^([\w\d]+\.)+\w+$/.test(kv.value)){
                   key = kv.value;
                   kv.setAttribute("name",key);
                   item = kv;
                   continue;
               }
               if(k=='val'){
                    if(/([0-9]{1,3}\.){3}[0-9]{1,3}/.test(kv.value)||kv.value==''){
                        val = kv.value;
                    }else{
                        val = '';
                    }
                    continue;
               }
            }
        }
        if(key!=''){
            localData[key]=val;
            if(item){
                item.value = val;
                item.setAttribute("value",val);
            }
        }
        key = ''; val = '';item='';
    }
    saveItems(localData);
    return true;
}
function saveItems(localData){
    var strs = [],domains = get('domains')||'';
    domains = domains.split('|');
    for(var i=0,il=domains.length;i<il;i++){
        if(!(domains[i] in localData)){
            set(domains[i],'',-1);
        }
    }
    for(var i in localData){
        strs.push(i);
        set(i,localData[i],7);
    }
    set('domains',strs.join('|'));
}
function restoreData(){
    var frag = document.createDocumentFragment(),
        span = document.getElementsByTagName('span')[0],
        domainStr = get('domains')||'',
        domains = domainStr.split('|'),
        sNames = {},
        inputS = [];
    for(var i=0,il=ipts.length;i<il;i++){
        var item = ipts[i];
        if(domainStr.indexOf(item.name) != -1){
            var val = get(item.name);
            for(var j=0,jl=ipts[i].options.length;j<jl;j++){
                if(ipts[i].options[j].value == val){
                    ipts[i].selectedIndex = j;
                    break;
                }
            }
        }
        if(item.name){ sNames[item.name] = true; }
    } 
    for(var j=0,jl=domains.length;j<jl;j++){
        var key = domains[j],
            val = get(key);
        if(key in sNames){ continue; }
        if(val && val.length){
            var t = document.createTextNode(key),
                s = document.createElement('select');
            s.name = key;
            s.isLocal = true;
            s.options[0] = new Option('现网Host','');
            s.options[0].comment = "IDC HOST";
            s.options[1] = new Option(val, val);
            frag.appendChild(t);
            frag.appendChild(s);
            sNames[key] = true;
            if(s.options[1]){s.options[1].selected = true;}
        }else{
            inputS.push(key);
        }
    }
    span.parentNode.insertBefore(frag,span);
    frag = document.createDocumentFragment();
    for(var j=0,jl=inputS.length;j<jl;j++){
        if(sNames[inputS[j]]){ continue; }
        var div = customDiv.cloneNode(true),
            child = div.childNodes;
        if(j == 0){ div = divs[0]; child = div.childNodes; }
        for(var i=0,il=child.length;i<il;i++){
            if(child[i].tagName=='INPUT'){
                var attr = child[i].getAttribute('key');
                if(attr == 'key'){
                    child[i].value = inputS[j];
                }
                if(attr == 'val'){
                    child[i].value = '';
                }
            }
        }
        if(j != 0){ frag.appendChild(div);}
    }
    addBtn.parentNode.insertBefore(frag,addBtn);
}
function splitQueryString(str){
    var strArr = str.split(/&+/gi),obj = {};
    for(var i=0,il=strArr.length; i<il; i++){
        var sp = strArr[i].split(/=+/gi);
        if(sp.length==2){
            try{obj[sp[0]] = decodeURIComponent(sp[1]); }catch(e){};
        }
    }
    return obj;
}
function setCookie(key,val,expr){
    var dt = new Date(),dtStr = '',etStr = '', cookieStr = '';
    expr = parseInt(expr);
    expr = isNaN(expr) ? 15 : expr;
    dt.setTime(dt.getTime() + expr * 3600*24*1000);
    dtStr = dt.toGMTString();
    document.cookie = oid+key + "=" + val + "; expires="+dtStr+"; path=/;";
}
function getCookie(key){
    var str = document.cookie,
        cookies = str.split(/;\s*/gi),
        ckObj = {};
    key = oid+key;
    for(var i =0,il=cookies.length; i<il; i++){
        var t = cookies[i].split('=');
        if(t[0] == key){
            return t[1];
        }
    }
}
function set(key,val,expr){
    try{localStorage.removeItem(oid+key);}catch(e){}
    if(expr>0){
        try{localStorage.setItem(oid+key,val);}catch(e){
        }
    }
    setCookie(key,val,expr);
}
function get(key){
    if(key in remoteConfig){
        return remoteConfig[key];
    }
    if(sLocal){
        return localStorage.getItem(oid+key);
    }else{
        return getCookie(key);
    }
}
function loadRemoteConfig(oid,cbk){
    var xhr = new XMLHttpRequest();
    if(!xhr){
        xhr = new ActiveXObject("Microsoft.XMLHTTP");
    }
    if(!xhr){
        if(cbk&&typeof(cbk)=='function'){cbk();};
        return;
    }
    xhr.open('GET','/Configs/'+oid+'.txt',true);
    xhr.onreadystatechange=function(){
        if(xhr.readyState == 4){
            if(xhr.status == 200){
                remoteConfig = splitQueryString(xhr.responseText);
            }
            if(cbk && typeof(cbk)=='function'){ cbk(); }
        }
    }
    xhr.send(null);
}
if('localStorage' in window){
    try{ localStorage.setItem('test_test','tests'); }
    catch(e){localStorage.clear();}
    localStorage.remoteItem('test_test');
}
(function(){
    var search = location.search.length>1?location.search.substr(1):'',
        gQuery = splitQueryString(search);
    if('oid' in gQuery){
        oid = gQuery.oid;
    }else{
        oid = 'smarthost_';
    }
    oid = oid.replace(/[^a-z0-9\_\-\.]+/gi,'').substr(0,30);
    if(oid != 'smarthost_'){
        loadRemoteConfig(oid,function(){
            document.getElementById('oidInput').value = oid;
            document.forms[0].action = 'done.html?'+search;
            ipts = document.getElementsByTagName('select');
            divs = document.getElementsByTagName('div');
            customDiv = divs[0].cloneNode(true);
            addBtn = document.getElementById('addBtnOne');
            restoreData();
        });
    }
})();
</script>
<script type="text/javascript" src="http://tajs.qq.com/stats?sId=28971616" charset="UTF-8"></script>
</body>
</html>